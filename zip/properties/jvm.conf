#!/bin/bash
# Configuration JVM optimisée pour Raspberry Pi
# Source ce fichier dans les scripts shell : source "$(dirname "$0")/jvm.conf"

# Détection automatique de la RAM disponible (portable Linux / macOS)
TOTAL_RAM_MB=""
if command -v free >/dev/null 2>&1; then
    TOTAL_RAM_MB=$(free -m 2>/dev/null | awk '/^Mem:/{print $2}')
elif [ -r /proc/meminfo ]; then
    TOTAL_RAM_KB=$(awk '/MemTotal:/{print $2}' /proc/meminfo 2>/dev/null || true)
    if [ -n "$TOTAL_RAM_KB" ]; then
        TOTAL_RAM_MB=$((TOTAL_RAM_KB / 1024))
    fi
elif command -v sysctl >/dev/null 2>&1; then
    TOTAL_RAM_BYTES=$(sysctl -n hw.memsize 2>/dev/null || true)
    if [ -n "$TOTAL_RAM_BYTES" ]; then
        TOTAL_RAM_MB=$((TOTAL_RAM_BYTES / 1024 / 1024))
    fi
fi

# Fallback si la détection échoue ou n'est pas numérique
if ! echo "$TOTAL_RAM_MB" | grep -qE '^[0-9]+$'; then
    TOTAL_RAM_MB=2048
fi

# Allocation heap selon RAM disponible
if [ "$TOTAL_RAM_MB" -le 1024 ]; then
    # Pi Zero / Pi 1 / Pi 2 (512MB-1GB)
    HEAP_SIZE="256m"
    METASPACE="128m"
elif [ "$TOTAL_RAM_MB" -le 2048 ]; then
    # Pi 3 (1GB)
    HEAP_SIZE="512m"
    METASPACE="192m"
elif [ "$TOTAL_RAM_MB" -le 4096 ]; then
    # Pi 4 (2GB-4GB)
    HEAP_SIZE="1g"
    METASPACE="256m"
else
    # Pi 4 (8GB) / Pi 5
    HEAP_SIZE="2g"
    METASPACE="384m"
fi

# Options JVM optimisées pour Raspberry Pi
JVM_OPTS="-Xms${HEAP_SIZE} -Xmx${HEAP_SIZE}"
JVM_OPTS="$JVM_OPTS -XX:MaxMetaspaceSize=${METASPACE}"

# GC optimisé pour faible latence sur ARM
JVM_OPTS="$JVM_OPTS -XX:+UseSerialGC"

# Réduction empreinte mémoire
JVM_OPTS="$JVM_OPTS -XX:+TieredCompilation"
JVM_OPTS="$JVM_OPTS -XX:TieredStopAtLevel=1"
JVM_OPTS="$JVM_OPTS -Djava.awt.headless=true"
JVM_OPTS="$JVM_OPTS -Dfile.encoding=UTF-8"

# Désactiver fonctionnalités inutiles
JVM_OPTS="$JVM_OPTS -XX:-UsePerfData"
JVM_OPTS="$JVM_OPTS -Dspring.jmx.enabled=false"

# Logging GC (optionnel, à commenter en production)
# JVM_OPTS="$JVM_OPTS -Xlog:gc*:file=logs/gc.log:time,level,tags"

export JVM_OPTS
